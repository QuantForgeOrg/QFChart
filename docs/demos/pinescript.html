<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>QFChart - PineScript Demo</title>

        <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
        <!-- QFChart Library -->
        <script src="../js/qfchart.dev.browser.js"></script>

        <!-- Dependencies for Data Loading -->
        <script src="../js/pinets.dev.browser.js"></script>
        <link rel="stylesheet" href="styles.css" />
    </head>

    <body>
        <nav>
            <a href="https://github.com/QuantForgeOrg/QFChart" target="_blank">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
                    />
                </svg>
                QFChart on GitHub
            </a>
        </nav>
        <div id="container">
            <h1>PineScript Demo</h1>

            <p>
                This demo loads and execute native pine script from this file
                <a href="../data/cross-signal.pine" target="_blank">cross-signal.pine</a>, then uses
                <a href="https://github.com/QuantForgeOrg/PineTS" target="_blank">PineTS</a> to execute it and get the results.<br />
                The results are then used by QFChart to render the chart.
            </p>
            <hr />
            <div id="main-chart"><p class="loading">Loading Data ...</p></div>
        </div>

        <div id="info">
            <h2>About This Demo - Native Pine Script Execution</h2>
            
            <h3>What is Pine Script?</h3>
            <p>
                <strong>Pine Script</strong> is TradingView's proprietary scripting language designed for creating custom technical indicators 
                and trading strategies. It provides a simple, intuitive syntax that allows traders to express complex mathematical calculations 
                and conditional logic without needing extensive programming knowledge. Pine Script is widely used by millions of traders 
                worldwide to build, test, and deploy custom trading tools.
            </p>

            <h3>PineTS: Pine Script Runtime for JavaScript</h3>
            <p>
                <strong>PineTS</strong> is a groundbreaking JavaScript/TypeScript library that brings Pine Script execution to the web. Unlike 
                other solutions that require pre-compilation or conversion, PineTS is a <strong>runtime transpiler</strong> that executes 
                Pine Script code directly in the browser or Node.js environment. This demo showcases PineTS's ability to:
            </p>
            <ul>
                <li><strong>Load Native Pine Script</strong> - Read .pine files directly without modification</li>
                <li><strong>Parse and Execute</strong> - Transpile Pine Script to executable JavaScript at runtime</li>
                <li><strong>Generate Indicator Data</strong> - Calculate indicator values across historical market data</li>
                <li><strong>Visualize with QFChart</strong> - Render the results in beautiful, interactive charts</li>
            </ul>

            <h3>The Cross Signal Indicator</h3>
            <p>
                This demo executes a <strong>Cross Signal</strong> indicator written in pure Pine Script. The indicator detects when 
                a fast moving average crosses above or below a slow moving average, generating buy and sell signals. Key features:
            </p>
            <ul>
                <li><strong>Configurable Parameters</strong> - Fast period (default: 9) and slow period (default: 21)</li>
                <li><strong>Visual Signals</strong> - Green upward triangles for buy signals, red downward triangles for sell signals</li>
                <li><strong>MA Plotting</strong> - Both moving averages are plotted on the chart for reference</li>
                <li><strong>Alert Conditions</strong> - Defines conditions for triggering alerts on crossovers</li>
            </ul>

            <h3>How This Demo Works</h3>
            <p>The execution flow demonstrates the full PineTS + QFChart integration:</p>
            <ol>
                <li><strong>Load Pine Script</strong> - Fetch the <code>cross-signal.pine</code> file via HTTP</li>
                <li><strong>Initialize PineTS</strong> - Create a PineTS instance with market data provider (Binance)</li>
                <li><strong>Execute Script</strong> - PineTS transpiles and runs the Pine Script on 500 weekly BTC/USDT candles</li>
                <li><strong>Extract Results</strong> - Get calculated indicator values and plot data</li>
                <li><strong>Initialize QFChart</strong> - Create a chart instance with the market data</li>
                <li><strong>Render Indicator</strong> - Add the Cross Signal plots as an overlay on the price chart</li>
            </ol>

            <h3>Technical Implementation</h3>
            <p>Behind the scenes, this demo showcases advanced capabilities:</p>
            <ul>
                <li><strong>Runtime Transpilation</strong> - PineTS parses Pine Script syntax into an Abstract Syntax Tree (AST), then transforms it into executable JavaScript</li>
                <li><strong>Scope Management</strong> - Properly handles Pine Script's unique variable scoping and series types</li>
                <li><strong>Built-in Functions</strong> - Implements Pine Script's <code>ta.*</code>, <code>math.*</code>, <code>plot()</code>, and other namespaces</li>
                <li><strong>Series Processing</strong> - Processes time-series data with forward storage and reverse indexing (Pine Script convention)</li>
                <li><strong>Plot Extraction</strong> - Converts Pine Script's plot calls into QFChart-compatible data structures</li>
            </ul>

            <h3>Benefits of Native Pine Script Execution</h3>
            <ul>
                <li><strong>Compatibility</strong> - Use existing Pine Script indicators without rewriting them in JavaScript</li>
                <li><strong>Community Ecosystem</strong> - Access thousands of public Pine Script indicators from TradingView</li>
                <li><strong>Rapid Prototyping</strong> - Write indicators in Pine Script's concise syntax, test instantly in the browser</li>
                <li><strong>No Compilation</strong> - Changes to .pine files are reflected immediately (just reload the page)</li>
                <li><strong>Cross-Platform</strong> - Run the same Pine Script code in browser, Node.js, or mobile apps</li>
            </ul>

            <h3>Sample Pine Script Code</h3>
            <p>Here's a simplified version of what the Cross Signal indicator looks like:</p>
            <pre><code>//@version=5
indicator("Cross Signal", overlay=true)

// Input parameters
fastLength = input.int(9, "Fast MA Length")
slowLength = input.int(21, "Slow MA Length")

// Calculate moving averages
fastMA = ta.sma(close, fastLength)
slowMA = ta.sma(close, slowLength)

// Detect crossovers
bullCross = ta.crossover(fastMA, slowMA)
bearCross = ta.crossunder(fastMA, slowMA)

// Plot MAs
plot(fastMA, "Fast MA", color.blue)
plot(slowMA, "Slow MA", color.red)

// Plot signals
plotshape(bullCross, "Buy", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(bearCross, "Sell", shape.triangledown, location.abovebar, color.red, size=size.small)
</code></pre>

            <h3>Use Cases</h3>
            <ul>
                <li><strong>Indicator Development</strong> - Develop custom indicators in Pine Script, visualize with QFChart</li>
                <li><strong>Strategy Backtesting</strong> - Load historical data and test Pine Script strategies programmatically</li>
                <li><strong>Trading Platforms</strong> - Build web-based trading platforms with support for user-created Pine Script indicators</li>
                <li><strong>Educational Tools</strong> - Create interactive tutorials that execute and explain Pine Script concepts</li>
                <li><strong>Research & Analysis</strong> - Run Pine Script indicators on custom datasets or alternative data sources</li>
            </ul>

            <h3>Getting Started</h3>
            <p>To execute your own Pine Script files:</p>
            <pre><code>// Load Pine Script source
const response = await fetch('your-indicator.pine');
const pineScript = await response.text();

// Execute with PineTS
const pineTS = new PineTS(PineTS.Provider.Binance, 'BTCUSDT', '1d', 500);
const { result, plots, marketData } = await pineTS.run(pineScript);

// Visualize with QFChart
const chart = new QFChart.QFChart(container, { title: 'My Indicator' });
chart.setMarketData(marketData);
chart.addIndicator('My Indicator', plots, { isOverlay: true });
</code></pre>

            <h3>Learn More</h3>
            <ul>
                <li><a href="https://github.com/QuantForgeOrg/PineTS" target="_blank">PineTS GitHub Repository</a></li>
                <li><a href="https://github.com/QuantForgeOrg/QFChart" target="_blank">QFChart GitHub Repository</a></li>
                <li><a href="https://www.tradingview.com/pine-script-docs/" target="_blank">Pine Script Official Documentation</a></li>
                <li><a href="../index.html">More QFChart Demos</a></li>
            </ul>
        </div>

        <script src="../js/indicators/macd.js"></script>

        <script>
            // Data Loading Helper (Simulating what was in chart.js)
            const DATA_LENGTH = 500;
            async function getIndicatorData(inficatorCode, tickerId, timeframe = '1w', periods = 500, stime, etime) {
                const pineTS = new PineTS(PineTS.Provider.Binance, tickerId, timeframe, periods, stime, etime);
                const { result, plots, marketData } = await pineTS.run(inficatorCode);
                return { result, plots, marketData };
            }

            // Load Pine Script source code from file
            async function loadPineScript(url) {
                const response = await fetch(url);
                return await response.text();
            }

            // Initialize QFChart
            document.addEventListener('DOMContentLoaded', async () => {
                // Load the Pine Script source code
                const crossSignalSource = await loadPineScript('../data/cross-signal.pine');

                const result = await getIndicatorData(crossSignalSource, 'BTCUSDT', 'W', DATA_LENGTH);

                const { marketData, plots: crossSignalPlots } = result;

                // Map Market Data to QFChart OHLCV format
                // marketData is array of objects: { openTime, open, high, low, close, volume }
                const ohlcvData = marketData.map((k) => ({
                    time: k.openTime,
                    open: k.open,
                    high: k.high,
                    low: k.low,
                    close: k.close,
                    volume: k.volume,
                }));

                const isMobileDevice = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

                // Initialize Chart
                const chartContainer = document.getElementById('main-chart');
                window.chart = new QFChart.QFChart(chartContainer, {
                    title: 'BTC/USDT', // Custom title
                    height: '600px',
                    padding: 0.2,
                    databox: {
                        position: isMobileDevice ? 'floating' : 'right',
                    },
                    dataZoom: {
                        visible: true,
                        position: 'top',
                        height: 6,
                        start: 50,
                        end: 100,
                    },
                    layout: {
                        mainPaneHeight: '60%',
                        gap: 5,
                    },
                    controls: {
                        collapse: true,
                        maximize: true,
                        fullscreen: true,
                    },
                });

                // Set Market Data
                chart.setMarketData(ohlcvData);

                // Set Indicators

                chart.addIndicator('Cross Signal', crossSignalPlots, {
                    isOverlay: true,
                    titleColor: '#2962FF',
                });

                // Register Measure Tool Plugin
                const measureTool = new QFChart.MeasureTool();
                chart.registerPlugin(measureTool);

                // Register Line Tool Plugin
                const lineTool = new QFChart.LineTool();
                chart.registerPlugin(lineTool);

                // Register Fibonacci Tool Plugin
                const fibTool = new QFChart.FibonacciTool();
                chart.registerPlugin(fibTool);
            });
        </script>
    </body>
</html>
