<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>QFChart - Pine Script Playground</title>

        <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
        <!-- QFChart Library -->
        <script src="../js/qfchart.dev.browser.js"></script>

        <!-- Dependencies for Data Loading -->
        <script src="../js/pinets.dev.browser.js"></script>
        <link rel="stylesheet" href="styles.css" />
        <style>
            .playground-container {
                display: grid;
                grid-template-columns: 1fr 2fr;
                gap: 20px;
                margin-top: 20px;
            }

            .editor-panel {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .editor-panel textarea {
                font-family: 'Courier New', monospace;
                font-size: 14px;
                padding: 15px;
                border: 1px solid #334155;
                border-radius: 4px;
                background: #1e293b;
                color: #cbd5e1;
                resize: vertical;
                min-height: 400px;
                line-height: 1.5;
                width: 100%;
            }

            .editor-panel textarea:focus {
                outline: none;
                border-color: #3b82f6;
            }

            .controls {
                display: flex;
                gap: 10px;
                align-items: center;
            }

            .controls select {
                padding: 8px 12px;
                border: 1px solid #334155;
                border-radius: 4px;
                background: #1e293b;
                color: #cbd5e1;
                font-size: 14px;
                cursor: pointer;
            }

            .controls select:focus {
                outline: none;
                border-color: #3b82f6;
            }

            .controls button {
                padding: 8px 24px;
                border: none;
                border-radius: 4px;
                background: #3b82f6;
                color: white;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s;
            }

            .controls button:hover {
                background: #2563eb;
            }

            .controls button:disabled {
                background: #475569;
                cursor: not-allowed;
            }

            .status {
                padding: 10px 15px;
                border-radius: 4px;
                font-size: 14px;
                display: none;
            }

            .status.success {
                background: #064e3b;
                color: #6ee7b7;
                border: 1px solid #065f46;
                display: block;
            }

            .status.error {
                background: #7f1d1d;
                color: #fca5a5;
                border: 1px solid #991b1b;
                display: block;
            }

            .status.loading {
                background: #1e3a8a;
                color: #93c5fd;
                border: 1px solid #1e40af;
                display: block;
            }

            .chart-panel {
                min-height: 600px;
            }

            #main-chart {
                min-height: 600px;
            }

            .examples {
                margin-top: 10px;
            }

            .examples label {
                display: block;
                color: #94a3b8;
                font-size: 14px;
                margin-bottom: 5px;
            }

            .examples button {
                padding: 6px 12px;
                margin-right: 8px;
                margin-bottom: 8px;
                border: 1px solid #334155;
                border-radius: 4px;
                background: #1e293b;
                color: #cbd5e1;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .examples button:hover {
                background: #334155;
                border-color: #475569;
            }

            @media (max-width: 1024px) {
                .playground-container {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>

    <body>
        <nav>
            <a href="https://github.com/QuantForgeOrg/QFChart" target="_blank">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
                    />
                </svg>
                QFChart on GitHub
            </a>
        </nav>
        <div id="container">
            <h1>Pine Script Playground</h1>
            <p>Write and test Pine Script indicators in real-time. Edit the code, select a timeframe, and click Run.</p>
            <hr />

            <div class="playground-container">
                <div class="editor-panel">
                    <div>
                        <label style="color: #94a3b8; font-size: 14px; margin-bottom: 5px; display: block">Pine Script Code:</label>
                        <textarea id="pine-code" placeholder="Write your Pine Script indicator here...">
//@version=5
indicator("My Indicator", overlay=true)

// Simple moving average crossover
fastMA = ta.sma(close, 9)
slowMA = ta.sma(close, 21)

// Plot the moving averages
plot(fastMA, "Fast MA", color.blue, linewidth=2)
plot(slowMA, "Slow MA", color.red, linewidth=2)

// Generate signals
bullCross = ta.crossover(fastMA, slowMA)
bearCross = ta.crossunder(fastMA, slowMA)

// Plot signals
plotshape(bullCross, "Buy", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(bearCross, "Sell", shape.triangledown, location.abovebar, color.red, size=size.small)</textarea
                        >
                    </div>

                    <div class="controls">
                        <select id="timeframe">
                            <option value="1">1 minute</option>
                            <option value="5">5 minutes</option>
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="1h">1 hour</option>
                            <option value="4h">4 hours</option>
                            <option value="D" selected>Daily</option>
                            <option value="W">Weekly</option>
                            <option value="M">Monthly</option>
                        </select>
                        <button id="run-btn">Run Indicator</button>
                    </div>

                    <div id="status" class="status"></div>

                    <div class="examples">
                        <label>Quick Examples:</label>
                        <button onclick="loadExample('sma')">Simple MA</button>
                        <button onclick="loadExample('ema')">EMA Crossover</button>
                        <button onclick="loadExample('rsi')">RSI</button>
                        <button onclick="loadExample('bb')">Bollinger Bands</button>
                        <button onclick="loadExample('macd')">MACD</button>
                    </div>
                </div>

                <div class="chart-panel">
                    <div id="main-chart"><p class="loading">Click "Run Indicator" to see the chart</p></div>
                </div>
            </div>
        </div>

        <script>
            let chart = null;
            const DATA_LENGTH = 500;

            const examples = {
                sma: `//@version=5
indicator("Simple Moving Average", overlay=true)

length = input.int(20, "Length")
sma = ta.sma(close, length)

plot(sma, "SMA", color.blue, linewidth=2)`,

                ema: `//@version=5
indicator("EMA Crossover", overlay=true)

fast = ta.ema(close, 12)
slow = ta.ema(close, 26)

plot(fast, "Fast EMA", color.blue)
plot(slow, "Slow EMA", color.red)

bullCross = ta.crossover(fast, slow)
bearCross = ta.crossunder(fast, slow)

plotshape(bullCross, "Buy", shape.triangleup, location.belowbar, color.green)
plotshape(bearCross, "Sell", shape.triangledown, location.abovebar, color.red)`,

                rsi: `//@version=5
indicator("RSI", overlay=false)

length = input.int(14, "Length")
rsi = ta.rsi(close, length)

plot(rsi, "RSI", color.purple, linewidth=2)
hline(70, "Overbought", color.red, linestyle=hline.style_dashed)
hline(30, "Oversold", color.green, linestyle=hline.style_dashed)
hline(50, "Midline", color.gray, linestyle=hline.style_dotted)`,

                bb: `//@version=5
indicator("Bollinger Bands", overlay=true)

length = input.int(20, "Length")
mult = input.float(2.0, "StdDev")

basis = ta.sma(close, length)
dev = mult * ta.stdev(close, length)
upper = basis + dev
lower = basis - dev

plot(basis, "Basis", color.blue)
plot(upper, "Upper", color.red)
plot(lower, "Lower", color.green)`,

                macd: `//@version=5
indicator("MACD", overlay=false)

fast = input.int(12, "Fast Length")
slow = input.int(26, "Slow Length")
signal = input.int(9, "Signal Length")

[macdLine, signalLine, hist] = ta.macd(close, fast, slow, signal)

plot(macdLine, "MACD", color.blue)
plot(signalLine, "Signal", color.orange)
plot(hist, "Histogram", color.gray, style=plot.style_histogram)`,
            };

            function loadExample(name) {
                const code = examples[name];
                if (code) {
                    document.getElementById('pine-code').value = code;
                }
            }

            function showStatus(message, type) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `status ${type}`;
            }

            function hideStatus() {
                const status = document.getElementById('status');
                status.style.display = 'none';
            }

            async function runIndicator() {
                const code = document.getElementById('pine-code').value.trim();
                const timeframe = document.getElementById('timeframe').value;
                const runBtn = document.getElementById('run-btn');

                if (!code) {
                    showStatus('Please enter Pine Script code', 'error');
                    return;
                }

                try {
                    runBtn.disabled = true;
                    showStatus('Loading market data and running indicator...', 'loading');

                    // Destroy existing chart
                    if (chart) {
                        chart.destroy();
                        chart = null;
                    }

                    // Run PineTS
                    const pineTS = new PineTS(PineTS.Provider.Binance, 'BTCUSDC', timeframe, DATA_LENGTH);
                    const { result, plots, marketData } = await pineTS.run(code);

                    // Map Market Data to QFChart OHLCV format
                    const ohlcvData = marketData.map((k) => ({
                        time: k.openTime,
                        open: k.open,
                        high: k.high,
                        low: k.low,
                        close: k.close,
                        volume: k.volume,
                    }));

                    const isMobileDevice = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

                    // Initialize Chart
                    const chartContainer = document.getElementById('main-chart');
                    chartContainer.innerHTML = ''; // Clear loading message

                    chart = new QFChart.QFChart(chartContainer, {
                        title: `BTC/USDC - ${getTimeframeName(timeframe)}`,
                        height: '600px',
                        padding: 0.2,
                        databox: {
                            position: 'floating',
                        },
                        dataZoom: {
                            visible: true,
                            position: 'top',
                            height: 6,
                            start: 70,
                            end: 100,
                        },
                        layout: {
                            mainPaneHeight: '70%',
                            gap: 5,
                        },
                        controls: {
                            collapse: true,
                            maximize: true,
                            fullscreen: true,
                        },
                    });

                    // Set Market Data
                    chart.setMarketData(ohlcvData);

                    // Detect if indicator is overlay or separate pane
                    const isOverlay = detectOverlay(code);

                    // Add Indicator
                    chart.addIndicator('User Indicator', plots, {
                        overlay: isOverlay,
                        height: isOverlay ? undefined : 30,
                        titleColor: '#3b82f6',
                        controls: { collapse: true, maximize: true },
                    });

                    // Register plugins
                    chart.registerPlugin(new QFChart.MeasureTool());
                    chart.registerPlugin(new QFChart.LineTool());
                    chart.registerPlugin(new QFChart.FibonacciTool());

                    showStatus(`âœ“ Indicator loaded successfully (${marketData.length} bars)`, 'success');
                    setTimeout(hideStatus, 3000);
                } catch (error) {
                    console.error('Error running indicator:', error);
                    showStatus(`Error: ${error.message || 'Failed to run indicator'}`, 'error');
                } finally {
                    runBtn.disabled = false;
                }
            }

            function detectOverlay(code) {
                // Simple detection: look for overlay=true or overlay=false in indicator() declaration
                const match = code.match(/indicator\([^)]*overlay\s*=\s*(true|false)/i);
                if (match) {
                    return match[1].toLowerCase() === 'true';
                }
                // Default to overlay=false (separate pane)
                return false;
            }

            function getTimeframeName(tf) {
                const names = {
                    1: '1 Min',
                    5: '5 Min',
                    15: '15 Min',
                    30: '30 Min',
                    '1h': '1 Hour',
                    '4h': '4 Hours',
                    D: 'Daily',
                    W: 'Weekly',
                    M: 'Monthly',
                };
                return names[tf] || tf;
            }

            // Event listeners
            document.getElementById('run-btn').addEventListener('click', runIndicator);

            // Allow Ctrl+Enter to run
            document.getElementById('pine-code').addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    runIndicator();
                }
            });

            // Load initial chart on page load
            window.addEventListener('DOMContentLoaded', () => {
                // Optionally auto-run on load
                // runIndicator();
            });
        </script>
    </body>
</html>
